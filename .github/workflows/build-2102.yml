name: OpenWrt 21.02 VisionSOM-6ULL + Docker

on:
  push:
    paths: [ '.config' ]
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-21.02
  CONFIG_FILE: .config
  FORCE_UNSAFE_CONFIGURE: 1    # 关键：提前全局生效！！！

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: p3terx/openwrt-build-env:20.04
      # 关键：去掉 --user root，改用普通用户 + sudo
      # options: --user root

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 克隆源码
        run: |
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt

      - name: 加载配置
        run: |
          cp .config openwrt/.config
          # 强制写死你的设备（防万一）
          sed -i '/CONFIG_TARGET_imx6ull_DEVICE_/d' openwrt/.config
          echo "CONFIG_TARGET_imx6ull_DEVICE_somlabs_sd=y" >> openwrt/.config
          # eMMC 版改成下面这行：
          # echo "CONFIG_TARGET_imx6ull_DEVICE_somlabs_emmc=y" >> openwrt/.config

      - name: Update feeds
        working-directory: ./openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig

      - name: 下载源码包
        working-directory: ./openwrt
        run: |
          make download -j8 || make download -j1
          find dl -size -1024c -exec rm -f {} \;

      - name: 编译固件
        working-directory: ./openwrt
        run: |
          echo "开始编译，使用 $(nproc) 线程"
          make -j$(nproc) V=s || make -j1 V=s

      - name: 上传固件
        run: |
          cd openwrt/bin/targets/imx6ull/generic
          mkdir -p ../../upload
          cp *somlabs_sd* sha256sums ../../upload/ 2>/dev/null || true
          ls -lh ../../upload/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-21.02-VisionSOM6ULL-${{ github.run_number }}
          path: openwrt/upload/*
