name: OpenWrt 21.02 VisionSOM-6ULL + Docker

on:
  push:
    paths: [ '.config' ]
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-21.02
  CONFIG_FILE: .config

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: p3terx/openwrt-build-env:20.04
      # 关键：这里保留 --user root（必须），后面会解决 tar 报错
      options: --user root

    steps:
      # 第一步：在宿主机 checkout（这里不会报 EACCES）
      - name: Checkout repository (host)
        uses: actions/checkout@v4

      # 第二步：把整个仓库复制进容器的工作目录
      - name: Copy source to container workspace
        run: |
          cp -a ./*   /__w/smartbox/smartbox/   2>/dev/null || true
          cp -a ./.*  /__w/smartbox/smartbox/   2>/dev/null || true
          ls -la /__w/smartbox/smartbox/

      # 下面所有步骤都在容器里执行
      - name: Clone OpenWrt Source
        run: |
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt

      - name: Load Custom Configuration
        run: |
          cp /__w/smartbox/smartbox/$CONFIG_FILE openwrt/.config
          # 强制锁定你的设备
          sed -i '/CONFIG_TARGET_imx6ull_DEVICE_/d' openwrt/.config
          echo "CONFIG_TARGET_imx6ull_DEVICE_somlabs_sd=y" >> openwrt/.config
          # eMMC 版改成下面这行：
          # echo "CONFIG_TARGET_imx6ull_DEVICE_somlabs_emmc=y" >> openwrt/.config

      - name: Update Feeds & Install
        working-directory: ./openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig

      - name: Download Packages
        working-directory: ./openwrt
        run: |
          export FORCE_UNSAFE_CONFIGURE=1
          make download -j8 || make download -j1
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile Firmware
        working-directory: ./openwrt
        run: |
          export FORCE_UNSAFE_CONFIGURE=1
          make -j$(nproc) V=s || make -j1 V=s

      - name: Organize & Upload
        run: |
          cd openwrt/bin/targets/imx6ull/generic 2>/dev/null || exit 0
          mkdir -p ../../upload
          cp *somlabs_sd* sha256sums ../../upload/ 2>/dev/null || true
          ls -lh ../../upload/
          echo "FIRMWARE_PATH=$PWD/../../upload" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-21.02-VisionSOM6ULL-${{ github.run_number }}
          path: ${{ env.FIRMWARE_PATH }}
