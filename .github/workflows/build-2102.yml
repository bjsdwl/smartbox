# .github/workflows/build-openwrt-2102.yml
name: Build OpenWrt 21.02 (i.MX6ULL + Docker)

on:
  push:
    paths:
      - '.config'           # 只要 .config 改了就自动编译
  workflow_dispatch:        # 也可以手动点运行

jobs:
  build:
    runs-on: ubuntu-22.04

    # 修正：使用官方通用 21.02 SDK 镜像（存在且稳定）
    container:
      image: openwrt/sdk:openwrt-21.02   # 通用标签，会动态下载 SDK
      options: --cpus 4                   # 限制 CPU 核心数，避免 runner 超载

    steps:
      - name: Checkout 代码（含你的 .config）
        uses: actions/checkout@v4

      - name: 准备编译环境（下载 imx6ull 21.02 SDK）
        run: |
          # 镜像启动后自动运行 setup.sh（如果有），然后手动下载 imx6ull SDK tarball
          if [ -f setup.sh ]; then ./setup.sh; fi
          
          # 下载官方 21.02.7 imx6ull SDK（最新稳定补丁，~1.5GB，5~10 分钟）
          wget https://downloads.openwrt.org/releases/21.02.7/targets/imx6ull/generic/openwrt-sdk-imx6ull-generic_gcc-8.4.0_musl.Linux-x86_64.tar.xz
          
          # 解压到 /openwrt（SDK 标准路径）
          tar -xzf openwrt-sdk-*.tar.xz -C / || tar -xzf *.tar.xz -C /
          
          # 进入 SDK 目录并验证
          cd /openwrt
          echo "OpenWrt version: $(cat Release 2>/dev/null || echo '21.02.7')"
          echo "Target: imx6ull/generic"
          ls -la | head -10

      - name: 复制你的 .config 并 defconfig
        run: |
          cd /openwrt
          cp /github/workspace/.config .config.custom  # 从仓库根目录复制
          make defconfig

      - name: 开始编译（多核 + 详细日志）
        run: |
          cd /openwrt
          make -j$(nproc) V=s || make -j1 V=s   # 失败时自动降到单核重试

      - name: 打包固件（只上传 imx6ull 相关文件）
        run: |
          cd /openwrt
          mkdir -p upload
          cp bin/targets/imx6ull/generic/*.{bin,dtb,img.gz,manifest} upload/ 2>/dev/null || true
          cp bin/targets/imx6ull/generic/sha256sums upload/ 2>/dev/null || true
          echo "=== 固件列表 ==="
          ls -lh upload/

      - name: 上传固件 Artifacts（成功后直接下载）
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-21.02-VisionSOM6ULL-${{ github.sha }}
          path: /openwrt/upload/*
          if-no-files-found: error
