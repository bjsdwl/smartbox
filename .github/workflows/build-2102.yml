# .github/workflows/build-openwrt-2102.yml
name: Build OpenWrt 21.02 (i.MX6ULL + Docker via ImageBuilder)

on:
  push:
    paths:
      - '.config'           # 只要 .config 改了就自动编译
  workflow_dispatch:        # 也可以手动点运行

jobs:
  build:
    runs-on: ubuntu-22.04

    # 修正：用官方 ImageBuilder 镜像（自带 imx6ull 21.02.7，无需 tarball）
    container:
      image: openwrtorg/imagebuilder:imx6ull-openwrt-21.02.7  # 官方镜像，完美支持 imx6ull
      options: --user root --cpus 4                          # root 权限 + CPU 限制

    steps:
      - name: Checkout 代码（含你的 .config）
        uses: actions/checkout@v4

      - name: 准备 ImageBuilder 环境
        run: |
          # ImageBuilder 自带工具链，验证版本
          echo "OpenWrt ImageBuilder version: $(cat .version 2>/dev/null || echo '21.02.7')"
          echo "Target: imx6ull/generic"
          echo "Available profiles: $(./scripts/profile_helper.sh list | head -10)"
          # 更新 feeds（确保 Docker 等包可用）
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 复制你的 .config 并生成镜像
        run: |
          # ImageBuilder 用 .config 直接构建（无需 defconfig，自动应用）
          cp /github/workspace/.config .config
          make image PROFILE="somlabs_sd" PACKAGES="docker dockerd containerd runc tini luci ttyd ser2net btrfs-progs px5g-wolfssl" V=s
          # 如果 eMMC 版，改 PROFILE="somlabs_emmc"

      - name: 打包固件（只上传 imx6ull 相关文件）
        run: |
          mkdir -p upload
          cp bin/targets/imx6ull/generic/*.{bin,dtb,img.gz,manifest,sysupgrade} upload/ 2>/dev/null || true
          cp bin/targets/imx6ull/generic/sha256sums upload/ 2>/dev/null || true
          echo "=== 固件列表 ==="
          ls -lh upload/

      - name: 上传固件 Artifacts（成功后直接下载）
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-21.02-VisionSOM6ULL-${{ github.sha }}
          path: upload/*
          if-no-files-found: error
