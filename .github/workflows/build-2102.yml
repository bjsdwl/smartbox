# .github/workflows/build-openwrt-2102.yml
name: Build OpenWrt 21.02 (i.MX6ULL + Docker)

on:
  push:
    paths:
      - '.config'           # 只要 .config 改了就自动编译
  workflow_dispatch:        # 也可以手动点运行

jobs:
  build:
    runs-on: ubuntu-22.04

    # 修正：使用官方 openwrt/sdk 镜像 + 正确的 imx6ull 标签
    container:
      image: openwrt/sdk:imx6ull-generic-openwrt-21.02   # 官方 21.02 SDK（会自动下载 tarball）
      options: --cpus 4                                  # 限制 CPU 核心数，避免 runner 超载

    steps:
      - name: Checkout 代码（含你的 .config）
        uses: actions/checkout@v4

      - name: 准备编译环境（镜像会自动 setup SDK）
        run: |
          # 镜像启动后会自动下载并解压 21.02 SDK（可能需要 2~5 分钟）
          echo "Current user: $(whoami)"
          echo "OpenWrt version: $(cat /openwrt/Release 2>/dev/null || echo '21.02')"
          echo "Target from config: $(grep CONFIG_TARGET .config | head -1)"
          # 等待 setup 完成（如果有 setup.sh）
          if [ -f setup.sh ]; then ./setup.sh; fi

      - name: 复制你的 .config 并 defconfig
        run: |
          cp .config .config.custom
          make defconfig

      - name: 开始编译（多核 + 详细日志）
        run: |
          make -j$(nproc) V=s || make -j1 V=s   # 失败时自动降到单核重试

      - name: 打包固件（只上传 imx6ull 相关文件）
        run: |
          mkdir -p upload
          cp bin/targets/imx6ull/generic/*.{bin,dtb,img.gz,manifest} upload/ 2>/dev/null || true
          cp bin/targets/imx6ull/generic/sha256sums upload/ 2>/dev/null || true
          echo "=== 固件列表 ==="
          ls -lh upload/

      - name: 上传固件 Artifacts（成功后直接下载）
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-21.02-VisionSOM6ULL-${{ github.sha }}
          path: upload/*
          if-no-files-found: error
