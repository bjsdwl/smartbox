name: Build OpenWrt Test (Native)

on:
  push:
    paths: [ '.config' ]
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: ubuntu-21.02
    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: 清理磁盘空间（避免 7GB 限额爆掉）
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo docker system prune -af || true
        df -h

    - name: 安装编译依赖
      run: |
        sudo apt update -y
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
            g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils \
            python3-setuptools rsync swig unzip wget time qemu-utils zip

    - name: Clone OpenWrt 源码（用稳定版 21.02 分支）
      run: |
        git clone https://github.com/openwrt/openwrt.git -b openwrt-21.02 openwrt-source
        cd openwrt-source

    - name: 准备 .config 和 feeds
      run: |
        cd openwrt-source
        cp ../.config .config  # 复制你的配置
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig  # 应用你的 .config

    - name: 编译固件（多核加速）
      run: |
        cd openwrt-source
        make -j$(nproc) V=s || make -j1 V=s  # V=s 详细日志，失败时单核重试

    - name: 打包并上传固件
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-VisionSOM6ULL-SD
        path: |
          openwrt-source/bin/targets/imx6ull/generic/
          openwrt-source/bin/targets/imx6ull/generic/sha256sums
        if-no-files-found: error
