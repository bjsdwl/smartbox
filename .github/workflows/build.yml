name: Build OpenWrt Test

on:
  push:
    paths: [ '.config' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: 清理磁盘空间（关键！不跑这个大概率爆磁盘）
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo docker image prune -af || true
        df -h

    - name: 安装基础依赖
      run: |
        sudo apt update -y
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
            g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils \
            python3-setuptools rsync swig unzip wget time qemu-utils

    - name: 使用最稳定的官方 Action（推荐）
      uses: openwrt/build-openwrt-action@main
      with:
        config_file: .config   # 直接使用你仓库里的 .config

    - name: 上传固件（成功后在这里下载）
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-firmware
        path: bin/targets/**/*
